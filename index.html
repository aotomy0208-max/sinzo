<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>番号チャット（固定自分表示版）</title>
<style>
body {font-family:"Segoe UI",sans-serif;margin:0;padding:0;background:#e5efff;}
.section {display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100%;}
input, button, select {font-size:18px;padding:10px;margin:6px;border-radius:8px;}
#chatUI {display:none;flex-direction:column;height:100vh;width:100%;}
#chat-header {background:#3a7bfd;color:white;padding:15px;font-size:20px;width:100%;text-align:center;position:sticky;top:0;}
#chat-area {flex:1;width:100%;overflow-y:auto;padding:15px;background:#f2f5ff;}
.message-box {display:flex;margin:10px 0;align-items:flex-end;max-width:90%;word-wrap:break-word;}
.message-box.me {justify-content:flex-end;}
.message-box.other {justify-content:flex-start;}
.bubble {padding:12px 16px;border-radius:18px;max-width:70%;position:relative;font-size:18px;}
.bubble.me {color:white;}
.name {font-size:12px;color:#666;margin:0 8px;}
.time {font-size:11px;color:#999;margin-top:3px;text-align:right;}
.readmark {font-size:10px;color:#3a7bfd;text-align:right;margin-top:2px;}
#send-area {display:flex;align-items:center;padding:10px;background:#fff;width:100%;}
#msgInput {flex:1;font-size:18px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-right:5px;}
#sendBtn {font-size:18px;padding:10px;border:none;border-radius:8px;background:#3a7bfd;color:white;cursor:pointer;margin-right:5px;}
#stamp-area {text-align:center;background:#fafafa;padding:8px;border-top:1px solid #ccc;width:100%;}
#stamp-area img {width:55px;cursor:pointer;margin:6px;transition:0.2s;}
#stamp-area img:hover {transform:scale(1.1);}
#imageInput {display:none;}
#uploadLabel {background:#4caf50;color:white;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:16px;margin-right:5px;}
#closeBtn {position:fixed;top:10px;right:10px;padding:8px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
.deleteBtn {margin-left:6px;background:#f44336;color:white;padding:3px 6px;border:none;border-radius:4px;cursor:pointer;font-size:12px;}
</style>
</head>
<body>

<!-- 部屋選択 -->
<div id="roomSelect" class="section">
  <h2>番号チャット</h2>
  <input type="text" id="nameInput" placeholder="名前"><br>
  <label>自分の色：</label>
  <select id="colorInput">
    <option value="#3a7bfd">青</option>
    <option value="#4caf50">緑</option>
    <option value="#ff69b4">ピンク</option>
    <option value="#ff9800">オレンジ</option>
    <option value="#9c27b0">紫</option>
    <option value="#607d8b">グレー</option>
    <option value="#e91e63">赤紫</option>
    <option value="#00bcd4">水色</option>
  </select><br>
  <input type="text" id="roomInput" placeholder="部屋番号"><br>
  <button id="enterBtn">部屋に入る</button>
  <button id="createBtn">部屋を作成</button>
</div>

<!-- チャット画面 -->
<div id="chatUI">
  <div id="chat-header"></div>
  <div id="chat-area"></div>
  <div id="send-area">
    <input type="text" id="msgInput" placeholder="メッセージ">
    <button id="sendBtn">送信</button>
    <label id="uploadLabel" for="imageInput">画像📷</label>
    <input type="file" id="imageInput" accept="image/*">
  </div>
  <div id="stamp-area">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-up_1f44d.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/red-heart_2764-fe0f.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/face-with-tears-of-joy_1f602.png">
  </div>
  <button id="closeBtn">閉じる</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, query, orderBy, onSnapshot, deleteDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebase
const firebaseConfig={apiKey:"AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",authDomain:"sinzo-3f972.firebaseapp.com",projectId:"sinzo-3f972",storageBucket:"sinzo-3f972.firebasestorage.app",messagingSenderId:"1058985227031",appId:"1:1058985227031:web:2e3a31346805442e10bd52"};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Elements
const roomSelect=document.getElementById("roomSelect");
const chatUI=document.getElementById("chatUI");
const chatHeader=document.getElementById("chat-header");
const chatArea=document.getElementById("chat-area");
const nameInput=document.getElementById("nameInput");
const colorInput=document.getElementById("colorInput");
const roomInput=document.getElementById("roomInput");
const enterBtn=document.getElementById("enterBtn");
const createBtn=document.getElementById("createBtn");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const imageInput=document.getElementById("imageInput");
const stamps=document.querySelectorAll("#stamp-area img");
const closeBtn=document.getElementById("closeBtn");

let userName="",currentRoom="";

// Cookie
function setCookie(k,v,d){const date=new Date();date.setTime(date.getTime()+d*24*60*60*1000);document.cookie=`${k}=${v};expires=${date.toUTCString()};path=/`;}
function getCookie(k){const pairs=document.cookie.split("; ");for(const p of pairs){const [key,val]=p.split("=");if(key===k)return val;}return"";}
window.addEventListener("load",()=>{const n=getCookie("chatName");if(n)nameInput.value=n;});

// Enter Room
function enterRoom(){userName=nameInput.value.trim();currentRoom=roomInput.value.trim();if(!userName||!currentRoom)return alert("名前と部屋番号を入力");setCookie("chatName",userName,365);roomSelect.style.display="none";chatUI.style.display="flex";chatHeader.textContent=`部屋番号：${currentRoom}`;startChat();}
enterBtn.onclick=enterRoom; createBtn.onclick=enterRoom;

// Chat
function startChat(){
  const roomRef=collection(db,"rooms",currentRoom,"messages");
  const q=query(roomRef,orderBy("time"));
  const messageDOM={};
  onSnapshot(q,(snapshot)=>{
    snapshot.docChanges().forEach(async change=>{
      const msg=change.doc.data();
      const id=change.doc.id;
      let box=document.getElementById(id);
      if(change.type==="removed"){if(box)box.remove();return;}
      if(!box){
        box=document.createElement("div");box.id=id;box.className="message-box "+(msg.name===userName?"me":"other");
        const bubble=document.createElement("div");bubble.className="bubble";if(msg.name===userName)bubble.classList.add("me");bubble.style.background=msg.color||"#fff";
        if(msg.type==="text"){bubble.textContent=msg.text;}
        else if(msg.type==="stamp"){const img=document.createElement("img");img.src=msg.src;img.style.width="60px";bubble.appendChild(img);}
        else if(msg.type==="image"){const img=document.createElement("img");img.src=msg.src;img.style.width="200px";img.style.borderRadius="10px";bubble.appendChild(img);}
        const time=document.createElement("div");time.className="time";if(msg.time?.toDate){const t=msg.time.toDate();time.textContent=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;}
        const nameTag=document.createElement("div");nameTag.className="name";nameTag.textContent=msg.name;
        const readmark=document.createElement("div");readmark.className="readmark";readmark.textContent=msg.read?"既読":"";
        if(msg.name===userName){box.append(bubble,nameTag,time,readmark);}else{box.append(nameTag,bubble,time);}
        
        // 削除ボタン（自分か管理者のみ）
        if(msg.name===userName){const delBtn=document.createElement("button");delBtn.textContent="削除";delBtn.className="deleteBtn";delBtn.onclick=async()=>{await deleteDoc(doc(db,"rooms",currentRoom,"messages",id));};box.appendChild(delBtn);}
        
        chatArea.appendChild(box);chatArea.scrollTop=chatArea.scrollHeight;
      }
      else{ // 既存メッセージ更新
        const readmark=box.querySelector(".readmark");if(readmark)readmark.textContent=msg.read?"既読":"";
      }
      if(msg.name!==userName)await updateDoc(doc(roomRef,id),{read:true});
    });
  });
}

// Send
sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();if(!text)return;
  const roomRef=collection(db,"rooms",currentRoom,"messages");
  await addDoc(roomRef,{name:userName,type:"text",text:text,color:colorInput.value,time:serverTimestamp(),read:false});
  msgInput.value="";
}

// Stamps
stamps.forEach(img=>{img.onclick=async()=>{const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:userName,type:"stamp",src:img.src,color:colorInput.value,time:serverTimestamp(),read:false});};});

// Images
imageInput.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const storageRef=ref(storage,`uploads/${currentRoom}/${Date.now()}_${file.name}`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:userName,type:"image",src:url,color:colorInput.value,time:serverTimestamp(),read:false});};

// Close
closeBtn.onclick=()=>{chatUI.style.display="none";roomSelect.style.display="flex";chatArea.innerHTML="";}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>番号チャット（固定自分表示版）</title>
<style>
body {font-family:"Segoe UI",sans-serif;margin:0;padding:0;background:#e5efff;}
.section {display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100%;}
input, button, select {font-size:18px;padding:10px;margin:6px;border-radius:8px;}
#chatUI {display:none;flex-direction:column;height:100vh;width:100%;}
#chat-header {background:#3a7bfd;color:white;padding:15px;font-size:20px;width:100%;text-align:center;position:sticky;top:0;}
#chat-area {flex:1;width:100%;overflow-y:auto;padding:15px;background:#f2f5ff;}
.message-box {display:flex;margin:10px 0;align-items:flex-end;max-width:90%;word-wrap:break-word;}
.message-box.me {justify-content:flex-end;}
.message-box.other {justify-content:flex-start;}
.bubble {padding:12px 16px;border-radius:18px;max-width:70%;position:relative;font-size:18px;}
.bubble.me {color:white;}
.name {font-size:12px;color:#666;margin:0 8px;}
.time {font-size:11px;color:#999;margin-top:3px;text-align:right;}
.readmark {font-size:10px;color:#3a7bfd;text-align:right;margin-top:2px;}
#send-area {display:flex;align-items:center;padding:10px;background:#fff;width:100%;}
#msgInput {flex:1;font-size:18px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-right:5px;}
#sendBtn {font-size:18px;padding:10px;border:none;border-radius:8px;background:#3a7bfd;color:white;cursor:pointer;margin-right:5px;}
#stamp-area {text-align:center;background:#fafafa;padding:8px;border-top:1px solid #ccc;width:100%;}
#stamp-area img {width:55px;cursor:pointer;margin:6px;transition:0.2s;}
#stamp-area img:hover {transform:scale(1.1);}
#imageInput {display:none;}
#uploadLabel {background:#4caf50;color:white;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:16px;margin-right:5px;}
#closeBtn {position:fixed;top:10px;right:10px;padding:8px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
.deleteBtn {margin-left:6px;background:#f44336;color:white;padding:3px 6px;border:none;border-radius:4px;cursor:pointer;font-size:12px;}
</style>
</head>
<body>

<!-- 部屋選択 -->
<div id="roomSelect" class="section">
  <h2>番号チャット</h2>
  <input type="text" id="nameInput" placeholder="名前"><br>
  <label>自分の色：</label>
  <select id="colorInput">
    <option value="#3a7bfd">青</option>
    <option value="#4caf50">緑</option>
    <option value="#ff69b4">ピンク</option>
    <option value="#ff9800">オレンジ</option>
    <option value="#9c27b0">紫</option>
    <option value="#607d8b">グレー</option>
    <option value="#e91e63">赤紫</option>
    <option value="#00bcd4">水色</option>
  </select><br>
  <input type="text" id="roomInput" placeholder="部屋番号"><br>
  <button id="enterBtn">部屋に入る</button>
  <button id="createBtn">部屋を作成</button>
</div>

<!-- チャット画面 -->
<div id="chatUI">
  <div id="chat-header"></div>
  <div id="chat-area"></div>
  <div id="send-area">
    <input type="text" id="msgInput" placeholder="メッセージ">
    <button id="sendBtn">送信</button>
    <label id="uploadLabel" for="imageInput">画像📷</label>
    <input type="file" id="imageInput" accept="image/*">
  </div>
  <div id="stamp-area">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-up_1f44d.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/red-heart_2764-fe0f.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/face-with-tears-of-joy_1f602.png">
  </div>
  <button id="closeBtn">閉じる</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, query, orderBy, onSnapshot, deleteDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebase
const firebaseConfig={apiKey:"AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",authDomain:"sinzo-3f972.firebaseapp.com",projectId:"sinzo-3f972",storageBucket:"sinzo-3f972.firebasestorage.app",messagingSenderId:"1058985227031",appId:"1:1058985227031:web:2e3a31346805442e10bd52"};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Elements
const roomSelect=document.getElementById("roomSelect");
const chatUI=document.getElementById("chatUI");
const chatHeader=document.getElementById("chat-header");
const chatArea=document.getElementById("chat-area");
const nameInput=document.getElementById("nameInput");
const colorInput=document.getElementById("colorInput");
const roomInput=document.getElementById("roomInput");
const enterBtn=document.getElementById("enterBtn");
const createBtn=document.getElementById("createBtn");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const imageInput=document.getElementById("imageInput");
const stamps=document.querySelectorAll("#stamp-area img");
const closeBtn=document.getElementById("closeBtn");

let userName="",currentRoom="";

// Cookie
function setCookie(k,v,d){const date=new Date();date.setTime(date.getTime()+d*24*60*60*1000);document.cookie=`${k}=${v};expires=${date.toUTCString()};path=/`;}
function getCookie(k){const pairs=document.cookie.split("; ");for(const p of pairs){const [key,val]=p.split("=");if(key===k)return val;}return"";}
window.addEventListener("load",()=>{const n=getCookie("chatName");if(n)nameInput.value=n;});

// Enter Room
function enterRoom(){userName=nameInput.value.trim();currentRoom=roomInput.value.trim();if(!userName||!currentRoom)return alert("名前と部屋番号を入力");setCookie("chatName",userName,365);roomSelect.style.display="none";chatUI.style.display="flex";chatHeader.textContent=`部屋番号：${currentRoom}`;startChat();}
enterBtn.onclick=enterRoom; createBtn.onclick=enterRoom;

// Chat
function startChat(){
  const roomRef=collection(db,"rooms",currentRoom,"messages");
  const q=query(roomRef,orderBy("time"));
  const messageDOM={};
  onSnapshot(q,(snapshot)=>{
    snapshot.docChanges().forEach(async change=>{
      const msg=change.doc.data();
      const id=change.doc.id;
      let box=document.getElementById(id);
      if(change.type==="removed"){if(box)box.remove();return;}
      if(!box){
        box=document.createElement("div");box.id=id;box.className="message-box "+(msg.name===userName?"me":"other");
        const bubble=document.createElement("div");bubble.className="bubble";if(msg.name===userName)bubble.classList.add("me");bubble.style.background=msg.color||"#fff";
        if(msg.type==="text"){bubble.textContent=msg.text;}
        else if(msg.type==="stamp"){const img=document.createElement("img");img.src=msg.src;img.style.width="60px";bubble.appendChild(img);}
        else if(msg.type==="image"){const img=document.createElement("img");img.src=msg.src;img.style.width="200px";img.style.borderRadius="10px";bubble.appendChild(img);}
        const time=document.createElement("div");time.className="time";if(msg.time?.toDate){const t=msg.time.toDate();time.textContent=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;}
        const nameTag=document.createElement("div");nameTag.className="name";nameTag.textContent=msg.name;
        const readmark=document.createElement("div");readmark.className="readmark";readmark.textContent=msg.read?"既読":"";
        if(msg.name===userName){box.append(bubble,nameTag,time,readmark);}else{box.append(nameTag,bubble,time);}
        
        // 削除ボタン（自分か管理者のみ）
        if(msg.name===userName){const delBtn=document.createElement("button");delBtn.textContent="削除";delBtn.className="deleteBtn";delBtn.onclick=async()=>{await deleteDoc(doc(db,"rooms",currentRoom,"messages",id));};box.appendChild(delBtn);}
        
        chatArea.appendChild(box);chatArea.scrollTop=chatArea.scrollHeight;
      }
      else{ // 既存メッセージ更新
        const readmark=box.querySelector(".readmark");if(readmark)readmark.textContent=msg.read?"既読":"";
      }
      if(msg.name!==userName)await updateDoc(doc(roomRef,id),{read:true});
    });
  });
}

// Send
sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();if(!text)return;
  const roomRef=collection(db,"rooms",currentRoom,"messages");
  await addDoc(roomRef,{name:userName,type:"text",text:text,color:colorInput.value,time:serverTimestamp(),read:false});
  msgInput.value="";
}

// Stamps
stamps.forEach(img=>{img.onclick=async()=>{const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:userName,type:"stamp",src:img.src,color:colorInput.value,time:serverTimestamp(),read:false});};});

// Images
imageInput.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const storageRef=ref(storage,`uploads/${currentRoom}/${Date.now()}_${file.name}`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:userName,type:"image",src:url,color:colorInput.value,time:serverTimestamp(),read:false});};

// Close
closeBtn.onclick=()=>{chatUI.style.display="none";roomSelect.style.display="flex";chatArea.innerHTML="";}
</script>
</body>
</html>
