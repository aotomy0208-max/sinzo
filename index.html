<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•ªå·ãƒãƒ£ãƒƒãƒˆï¼ˆFirestoreï¼‰</title>
<style>
body {
  font-family: sans-serif;
  background: #eef4ff;
  text-align: center;
  margin: 0;
  padding: 0;
}
#chat-area {
  max-width: 600px;
  margin: 20px auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 0 10px #ccc;
  padding: 10px;
  height: 400px;
  overflow-y: auto;
  text-align: left;
}
.message {
  margin: 6px 0;
  padding: 6px 10px;
  border-radius: 8px;
  display: inline-block;
  max-width: 80%;
  word-wrap: break-word;
}
.me { background: #d2eaff; }
.other { background: #eee; }
input, button {
  font-size: 16px;
  padding: 8px;
  margin: 5px;
  border-radius: 5px;
  border: 1px solid #ccc;
}
#stamp-area img {
  width: 40px;
  cursor: pointer;
  margin: 5px;
}
</style>
</head>
<body>
<h1>ç•ªå·ãƒãƒ£ãƒƒãƒˆ</h1>

<div id="login">
  <input type="text" id="roomInput" placeholder="éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›">
  <button id="enterBtn">å…¥å®¤</button>
</div>

<div id="chatUI" style="display:none;">
  <h2 id="roomLabel"></h2>
  <div id="chat-area"></div>
  <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button id="sendBtn">é€ä¿¡</button>

  <div id="stamp-area">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-up_1f44d.png" alt="ğŸ‘">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/red-heart_2764-fe0f.png" alt="â¤ï¸">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png" alt="ğŸ”¥">
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",
    authDomain: "sinzo-3f972.firebaseapp.com",
    projectId: "sinzo-3f972",
    storageBucket: "sinzo-3f972.firebasestorage.app",
    messagingSenderId: "1058985227031",
    appId: "1:1058985227031:web:2e3a31346805442e10bd52"
  };

  // åˆæœŸåŒ–
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // è¦ç´ å–å¾—
  const login = document.getElementById("login");
  const chatUI = document.getElementById("chatUI");
  const roomInput = document.getElementById("roomInput");
  const enterBtn = document.getElementById("enterBtn");
  const roomLabel = document.getElementById("roomLabel");
  const chatArea = document.getElementById("chat-area");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const stamps = document.querySelectorAll("#stamp-area img");

  let room = "";
  let userId = "u" + Math.random().toString(36).substring(2, 9);

  // å…¥å®¤å‡¦ç†
  enterBtn.onclick = async () => {
    room = roomInput.value.trim();
    if (!room) return alert("éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ã­ã€‚");

    roomLabel.textContent = "éƒ¨å±‹ç•ªå·ï¼š" + room;
    login.style.display = "none";
    chatUI.style.display = "block";
    startChat();
  };

  // ãƒãƒ£ãƒƒãƒˆèª­ã¿è¾¼ã¿é–‹å§‹
  function startChat() {
    const roomRef = collection(db, "rooms", room, "messages");
    const q = query(roomRef, orderBy("time"));
    onSnapshot(q, (snapshot) => {
      chatArea.innerHTML = "";
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "message " + (msg.user === userId ? "me" : "other");
        if (msg.type === "text") {
          div.textContent = msg.text;
        } else if (msg.type === "stamp") {
          const img = document.createElement("img");
          img.src = msg.src;
          img.style.width = "40px";
          div.appendChild(img);
        }
        chatArea.appendChild(div);
      });
      chatArea.scrollTop = chatArea.scrollHeight;
    });
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if (!text) return;
    const roomRef = collection(db, "rooms", room, "messages");
    await addDoc(roomRef, {
      user: userId,
      type: "text",
      text: text,
      time: serverTimestamp()
    });
    msgInput.value = "";
  };

  // ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡
  stamps.forEach(img => {
    img.onclick = async () => {
      const roomRef = collection(db, "rooms", room, "messages");
      await addDoc(roomRef, {
        user: userId,
        type: "stamp",
        src: img.src,
        time: serverTimestamp()
      });
    };
  });
</script>
</body>
</html>
