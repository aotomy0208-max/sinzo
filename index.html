<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•ªå·ãƒãƒ£ãƒƒãƒˆï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆç‰ˆï¼‰</title>
<style>
body {font-family:"Segoe UI",sans-serif;margin:0;padding:0;background:#e5efff;}
.section {display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;width:100%;}
input, button, select {font-size:18px;padding:10px;margin:6px;border-radius:8px;}
#chatUI {display:none;flex-direction:column;height:100vh;width:100%;}
#chat-header {background:#3a7bfd;color:white;padding:15px;font-size:20px;width:100%;text-align:center;position:sticky;top:0;}
#chat-area {flex:1;width:100%;overflow-y:auto;padding:15px;background:#f2f5ff;}
.message-box {display:flex;margin:10px 0;align-items:flex-end;max-width:90%;word-wrap:break-word;}
.message-box.me {justify-content:flex-end;}
.message-box.other {justify-content:flex-start;}
.bubble {padding:12px 16px;border-radius:18px;max-width:70%;position:relative;font-size:18px;}
.bubble.me {color:white;}
.name {font-size:12px;color:#666;margin:0 8px;}
.time {font-size:11px;color:#999;margin-top:3px;text-align:right;}
.readmark {font-size:10px;color:#3a7bfd;text-align:right;margin-top:2px;}
#send-area {display:flex;align-items:center;padding:10px;background:#fff;width:100%;}
#msgInput {flex:1;font-size:18px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-right:5px;}
#sendBtn {font-size:18px;padding:10px;border:none;border-radius:8px;background:#3a7bfd;color:white;cursor:pointer;margin-right:5px;}
#stamp-area {text-align:center;background:#fafafa;padding:8px;border-top:1px solid #ccc;width:100%;}
#stamp-area img {width:55px;cursor:pointer;margin:6px;transition:0.2s;}
#stamp-area img:hover {transform:scale(1.1);}
#imageInput {display:none;}
#uploadLabel {background:#4caf50;color:white;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:16px;margin-right:5px;}
#closeBtn {position:fixed;top:10px;right:10px;padding:8px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
#adminBtn {position:fixed;top:10px;left:10px;padding:8px 12px;background:#607d8b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
.deleteBtn {margin-left:6px;background:#f44336;color:white;padding:3px 6px;border:none;border-radius:4px;cursor:pointer;font-size:12px;}
</style>
</head>
<body>

<!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”»é¢ -->
<div id="accountUI" class="section">
  <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <input type="text" id="userNameInput" placeholder="åå‰"><br>
  <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button id="createAccountBtn">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
  <button id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<!-- éƒ¨å±‹é¸æŠ -->
<div id="roomSelect" class="section" style="display:none;">
  <h2>ç•ªå·ãƒãƒ£ãƒƒãƒˆ</h2>
  <label>è‡ªåˆ†ã®è‰²ï¼š</label>
  <select id="colorInput">
    <option value="#3a7bfd">é’</option>
    <option value="#4caf50">ç·‘</option>
    <option value="#ff69b4">ãƒ”ãƒ³ã‚¯</option>
    <option value="#ff9800">ã‚ªãƒ¬ãƒ³ã‚¸</option>
    <option value="#9c27b0">ç´«</option>
    <option value="#607d8b">ã‚°ãƒ¬ãƒ¼</option>
    <option value="#e91e63">èµ¤ç´«</option>
    <option value="#00bcd4">æ°´è‰²</option>
  </select><br>
  <input type="text" id="roomInput" placeholder="éƒ¨å±‹ç•ªå·"><br>
  <button id="enterBtn">éƒ¨å±‹ã«å…¥ã‚‹</button>
  <button id="createBtn">éƒ¨å±‹ã‚’ä½œæˆ</button>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
<div id="chatUI">
  <div id="chat-header"></div>
  <div id="chat-area"></div>
  <div id="send-area">
    <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
    <button id="sendBtn">é€ä¿¡</button>
    <label id="uploadLabel" for="imageInput">ç”»åƒğŸ“·</label>
    <input type="file" id="imageInput" accept="image/*">
  </div>
  <div id="stamp-area">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-up_1f44d.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/red-heart_2764-fe0f.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/face-with-tears-of-joy_1f602.png">
  </div>
  <button id="closeBtn">é–‰ã˜ã‚‹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, orderBy, onSnapshot, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebaseè¨­å®š
const firebaseConfig={apiKey:"AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",authDomain:"sinzo-3f972.firebaseapp.com",projectId:"sinzo-3f972",storageBucket:"sinzo-3f972.firebasestorage.app",messagingSenderId:"1058985227031",appId:"1:1058985227031:web:2e3a31346805442e10bd52"};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// è¦ç´ 
const accountUI = document.getElementById("accountUI");
const roomSelect = document.getElementById("roomSelect");
const chatUI = document.getElementById("chatUI");
const chatHeader = document.getElementById("chat-header");
const chatArea = document.getElementById("chat-area");
const userNameInput = document.getElementById("userNameInput");
const passwordInput = document.getElementById("passwordInput");
const createAccountBtn = document.getElementById("createAccountBtn");
const loginBtn = document.getElementById("loginBtn");
const colorInput = document.getElementById("colorInput");
const roomInput = document.getElementById("roomInput");
const enterBtn = document.getElementById("enterBtn");
const createBtn = document.getElementById("createBtn");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const imageInput = document.getElementById("imageInput");
const stamps = document.querySelectorAll("#stamp-area img");
const closeBtn = document.getElementById("closeBtn");

let currentUser = null; // {name,password,isAdmin}
let currentRoom = "";

// Cookieç®¡ç†
function setCookie(k,v,d){const date=new Date();date.setTime(date.getTime()+d*24*60*60*1000);document.cookie=`${k}=${v};expires=${date.toUTCString()};path=/`;}
function getCookie(k){const pairs=document.cookie.split("; ");for(const p of pairs){const [key,val]=p.split("=");if(key===k)return val;}return"";}

// è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
window.addEventListener("load", async()=>{
  const savedName=getCookie("chatName");
  if(savedName){
    const userDoc = await getDoc(doc(db,"users",savedName));
    if(userDoc.exists()){currentUser=userDoc.data();accountUI.style.display="none";roomSelect.style.display="flex";userNameInput.value=savedName;colorInput.value="#3a7bfd";}
  }
});

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
createAccountBtn.onclick=async()=>{
  const name=userNameInput.value.trim();
  const pass=passwordInput.value.trim();
  if(!name||!pass)return alert("å…¥åŠ›å¿…é ˆ");
  const userRef = doc(db,"users",name);
  const docSnap = await getDoc(userRef);
  if(docSnap.exists())return alert("åå‰ãŒæ—¢ã«å­˜åœ¨");
  await setDoc(userRef,{password:pass,isAdmin:false});
  currentUser={name,password:pass,isAdmin:false};
  setCookie("chatName",name,365);
  accountUI.style.display="none";roomSelect.style.display="flex";
}

// ãƒ­ã‚°ã‚¤ãƒ³
loginBtn.onclick=async()=>{
  const name=userNameInput.value.trim();
  const pass=passwordInput.value.trim();
  if(!name||!pass)return alert("å…¥åŠ›å¿…é ˆ");
  const userDoc = await getDoc(doc(db,"users",name));
  if(!userDoc.exists())return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—");
  const data=userDoc.data();
  if(data.password!==pass)return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã†");
  currentUser={name,password:pass,isAdmin:data.isAdmin};
  setCookie("chatName",name,365);
  accountUI.style.display="none";roomSelect.style.display="flex";
}

// éƒ¨å±‹å…¥å®¤
function enterRoom(){ 
  currentRoom=roomInput.value.trim(); 
  if(!currentRoom)return alert("éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›"); 
  roomSelect.style.display="none";chatUI.style.display="flex";chatHeader.textContent=`éƒ¨å±‹ç•ªå·ï¼š${currentRoom}`;
  startChat();
}
enterBtn.onclick=enterRoom; createBtn.onclick=enterRoom;

// ãƒãƒ£ãƒƒãƒˆ
function startChat(){
  const roomRef = collection(db,"rooms",currentRoom,"messages");
  const q = query(roomRef,orderBy("time"));
  onSnapshot(q,(snapshot)=>{
    snapshot.docChanges().forEach(async change=>{
      const msg=change.doc.data();
      const id=change.doc.id;
      let box=document.getElementById(id);
      if(change.type==="removed"){if(box)box.remove();return;}
      if(!box){
        box=document.createElement("div");box.id=id;box.className="message-box "+(msg.name===currentUser.name?"me":"other");
        const bubble=document.createElement("div");bubble.className="bubble";if(msg.name===currentUser.name)bubble.classList.add("me");bubble.style.background=msg.color||"#fff";
        if(msg.type==="text"){bubble.textContent=msg.text;}
        else if(msg.type==="stamp"){const img=document.createElement("img");img.src=msg.src;img.style.width="60px";bubble.appendChild(img);}
        else if(msg.type==="image"){const img=document.createElement("img");img.src=msg.src;img.style.width="200px";img.style.borderRadius="10px";bubble.appendChild(img);}
        const time=document.createElement("div");time.className="time";if(msg.time?.toDate){const t=msg.time.toDate();time.textContent=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;}
        const nameTag=document.createElement("div");nameTag.className="name";nameTag.textContent=msg.name;
        const readmark=document.createElement("div");readmark.className="readmark";readmark.textContent=msg.read?"æ—¢èª­":"";
        if(msg.name===currentUser.name){box.append(bubble,nameTag,time,readmark);}else{box.append(nameTag,bubble,time);}
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³
        if(currentUser.isAdmin || msg.name===currentUser.name){
          const delBtn=document.createElement("button");delBtn.textContent="å‰Šé™¤";delBtn.className="deleteBtn";
          delBtn.onclick=async()=>{await deleteDoc(doc(db,"rooms",currentRoom,"messages",id));};
          box.appendChild(delBtn);
        }

        chatArea.appendChild(box);chatArea.scrollTop=chatArea.scrollHeight;
      }
      else{ // æ—¢å­˜æ›´æ–°
        const readmark=box.querySelector(".readmark");if(readmark)readmark.textContent=msg.read?"æ—¢èª­":"";
      }
      if(msg.name!==currentUser.name)await updateDoc(doc(db,"rooms",currentRoom,"messages",id),{read:true});
    });
  });
}

// é€ä¿¡
sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();if(!text)return;
  const roomRef=collection(db,"rooms",currentRoom,"messages");
  await addDoc(roomRef,{name:currentUser.name,type:"text",text:text,color:colorInput.value,time:serverTimestamp(),read:false});
  msgInput.value="";
}

// ã‚¹ã‚¿ãƒ³ãƒ—
stamps.forEach(img=>{img.onclick=async()=>{const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:currentUser.name,type:"stamp",src:img.src,color:colorInput.value,time:serverTimestamp(),read:false});};});

// ç”»åƒ
imageInput.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const storageRef=ref(storage,`uploads/${currentRoom}/${Date.now()}_${file.name}`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);const roomRef=collection(db,"rooms",currentRoom,"messages");await addDoc(roomRef,{name:currentUser.name,type:"image",src:url,color:colorInput.value,time:serverTimestamp(),read:false});};

// é–‰ã˜ã‚‹
closeBtn.onclick=()=>{chatUI.style.display="none";roomSelect.style.display="flex";chatArea.innerHTML="";}
</script>
</body>
</html>
