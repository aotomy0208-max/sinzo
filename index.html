<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>番号チャット（部屋版）</title>
<style>
body {font-family:"Segoe UI",sans-serif;margin:0;padding:0;background:#e5efff;}
#roomSelect, #chatUI {display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
#roomSelect input, #roomSelect button, #roomSelect select {font-size:20px;padding:10px;margin:6px;border-radius:8px;}
#chatUI {display:none;height:100vh;}
#chat-header {background:#3a7bfd;color:white;padding:15px;font-size:20px;width:100%;text-align:center;position:sticky;top:0;}
#chat-area {flex:1;width:100%;overflow-y:auto;padding:15px;background:#f2f5ff;}
.message-box {display:flex;margin:10px 0;align-items:flex-end;max-width:90%;word-wrap:break-word;}
.message-box.me {justify-content:flex-end;}
.message-box.other {justify-content:flex-start;}
.bubble {padding:12px 16px;border-radius:18px;max-width:70%;position:relative;font-size:18px;}
.bubble.me {color:white;}
.name {font-size:12px;color:#666;margin:0 8px;}
.time {font-size:11px;color:#999;margin-top:3px;text-align:right;}
.readmark {font-size:10px;color:#3a7bfd;text-align:right;margin-top:2px;}
#send-area {display:flex;align-items:center;padding:10px;background:#fff;width:100%;}
#msgInput {flex:1;font-size:18px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-right:5px;}
#sendBtn {font-size:18px;padding:10px;border:none;border-radius:8px;background:#3a7bfd;color:white;cursor:pointer;margin-right:5px;}
#stamp-area {text-align:center;background:#fafafa;padding:8px;border-top:1px solid #ccc;width:100%;}
#stamp-area img {width:55px;cursor:pointer;margin:6px;transition:0.2s;}
#stamp-area img:hover {transform:scale(1.1);}
#imageInput {display:none;}
#uploadLabel {background:#4caf50;color:white;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:16px;margin-right:5px;}
#closeBtn {position:fixed;top:10px;right:10px;padding:8px 12px;background:#f44336;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
#adminBtn {position:fixed;top:10px;left:10px;padding:8px 12px;background:#607d8b;color:white;border:none;border-radius:6px;cursor:pointer;font-size:16px;}
</style>
</head>
<body>

<div id="roomSelect">
  <h2>番号チャット</h2>
  <input type="text" id="nameInput" placeholder="名前を入力"><br>
  <label>自分の色：</label>
  <select id="colorInput">
    <option value="#3a7bfd">青</option>
    <option value="#4caf50">緑</option>
    <option value="#ff69b4">ピンク</option>
    <option value="#ff9800">オレンジ</option>
    <option value="#9c27b0">紫</option>
    <option value="#607d8b">グレー</option>
    <option value="#e91e63">赤紫</option>
    <option value="#00bcd4">水色</option>
  </select><br>
  <input type="text" id="roomInput" placeholder="部屋番号を入力"><br>
  <button id="enterBtn">部屋に入る</button>
  <button id="createBtn">部屋を作成</button>
</div>

<div id="chatUI">
  <div id="chat-header"></div>
  <div id="chat-area"></div>
  <div id="send-area">
    <input type="text" id="msgInput" placeholder="メッセージを入力">
    <button id="sendBtn">送信</button>
    <label id="uploadLabel" for="imageInput">画像📷</label>
    <input type="file" id="imageInput" accept="image/*">
  </div>
  <div id="stamp-area">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-up_1f44d.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/red-heart_2764-fe0f.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/fire_1f525.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/face-with-tears-of-joy_1f602.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/clapping-hands_1f44f.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/sparkles_2728.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/ok-hand_1f44c.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/eyes_1f440.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/thumbs-down_1f44e.png">
    <img src="https://em-content.zobj.net/thumbs/240/apple/354/party-popper_1f389.png">
  </div>
  <button id="closeBtn">閉じる</button>
  <button id="adminBtn">管理者</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// Firebase設定
const firebaseConfig = {
  apiKey: "AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",
  authDomain: "sinzo-3f972.firebaseapp.com",
  projectId: "sinzo-3f972",
  storageBucket: "sinzo-3f972.firebasestorage.app",
  messagingSenderId: "1058985227031",
  appId: "1:1058985227031:web:2e3a31346805442e10bd52"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// 要素
const roomSelect = document.getElementById("roomSelect");
const chatUI = document.getElementById("chatUI");
const chatHeader = document.getElementById("chat-header");
const chatArea = document.getElementById("chat-area");
const nameInput = document.getElementById("nameInput");
const colorInput = document.getElementById("colorInput");
const roomInput = document.getElementById("roomInput");
const enterBtn = document.getElementById("enterBtn");
const createBtn = document.getElementById("createBtn");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const imageInput = document.getElementById("imageInput");
const stamps = document.querySelectorAll("#stamp-area img");
const closeBtn = document.getElementById("closeBtn");
const adminBtn = document.getElementById("adminBtn");

let userName = "";
let color = "";
let room = "";

// ===== クッキー管理 =====
function setCookie(key,val,days){const d=new Date();d.setTime(d.getTime()+(days*24*60*60*1000));document.cookie=`${key}=${val};expires=${d.toUTCString()};path=/`;}
function getCookie(key){const pairs=document.cookie.split("; ");for(let p of pairs){const [k,v]=p.split("=");if(k===key)return v;}return"";}

// ===== 名前自動復元 =====
window.addEventListener("load",()=>{const savedName=getCookie("chatName");if(savedName)nameInput.value=savedName;});

// ===== 部屋入室/作成 =====
function enterRoom(){userName=nameInput.value.trim();color=colorInput.value;room=roomInput.value.trim();if(!userName||!room)return alert("名前と部屋番号を入力");setCookie("chatName",userName,365);roomSelect.style.display="none";chatUI.style.display="flex";chatHeader.textContent=`部屋番号：${room}`;startChat();}
enterBtn.onclick=enterRoom;createBtn.onclick=enterRoom;

// ===== チャット =====
function startChat(){
  const roomRef=collection(db,"rooms",room,"messages");
  const q=query(roomRef,orderBy("time"));
  onSnapshot(q,(snapshot)=>{
    chatArea.innerHTML="";
    snapshot.forEach(async(docSnap)=>{
      const msg=docSnap.data();
      const box=document.createElement("div");
      box.className="message-box "+(msg.name===userName?"me":"other");
      const bubble=document.createElement("div");
      bubble.className="bubble";
      if(msg.name===userName)bubble.classList.add("me");
      bubble.style.background=msg.color||"#fff";
      if(msg.type==="text"){bubble.textContent=msg.text;}
      else if(msg.type==="stamp"){const img=document.createElement("img");img.src=msg.src;img.style.width="60px";bubble.appendChild(img);}
      else if(msg.type==="image"){const img=document.createElement("img");img.src=msg.src;img.style.width="200px";img.style.borderRadius="10px";bubble.appendChild(img);}
      const time=document.createElement("div");time.className="time";if(msg.time?.toDate){const t=msg.time.toDate();time.textContent=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`;}
      const nameTag=document.createElement("div");nameTag.className="name";nameTag.textContent=msg.name;
      const readmark=document.createElement("div");readmark.className="readmark";readmark.textContent=msg.read?"既読":"";
      if(msg.name===userName){box.append(bubble,nameTag,time,readmark);}
      else{box.append(nameTag,bubble,time);await updateDoc(doc(roomRef,docSnap.id),{read:true});}
      chatArea.appendChild(box);
    });
    chatArea.scrollTop=chatArea.scrollHeight;
  });
}

// ===== テキスト送信 =====
sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();if(!text)return;
  const roomRef=collection(db,"rooms",room,"messages");
  await addDoc(roomRef,{name:userName,type:"text",text:text,color:color,time:serverTimestamp(),read:false});
  msgInput.value="";
}

// ===== スタンプ送信 =====
stamps.forEach(img=>{img.onclick=async()=>{const roomRef=collection(db,"rooms",room,"messages");await addDoc(roomRef,{name:userName,type:"stamp",src:img.src,color:color,time:serverTimestamp(),read:false});};});

// ===== 画像送信 =====
imageInput.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const storageRef=ref(storage,`uploads/${room}/${Date.now()}_${file.name}`);await uploadBytes(storageRef,file);const url=await getDownloadURL(storageRef);const roomRef=collection(db,"rooms",room,"messages");await addDoc(roomRef,{name:userName,type:"image",src:url,color:color,time:serverTimestamp(),read:false});};

// ===== 閉じる =====
closeBtn.onclick=()=>{chatUI.style.display="none";roomSelect.style.display="flex";chatArea.innerHTML="";}

// ===== 管理者削除 =====
adminBtn.onclick=async()=>{
  const pw=prompt("管理者パスワードを入力");if(pw!=="2059")return alert("パスワード違う");
  const delId=prompt("削除するメッセージのIDを入力");if(!delId)return;
  try{await deleteDoc(doc(db,"rooms",room,"messages",delId));alert("削除しました");}catch(e){alert("削除できません");}
}
</script>
</body>
</html>
