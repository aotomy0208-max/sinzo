<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Firebase WebRTC Call</title>
  <style>
    body { font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; background:#f5f7fb; color:#111; padding:20px; }
    h1 { font-size:20px; margin:0 0 12px; }
    .container { max-width:900px; margin:0 auto; display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start; }
    .panel { background:#fff; border-radius:10px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.06); }
    video { width:100%; height:320px; background:#000; border-radius:6px; object-fit:cover; }
    label { display:block; margin:8px 0 4px; font-size:14px; }
    input[type="text"] { width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    .controls { display:flex; gap:8px; margin-top:8px; }
    button { padding:8px 12px; border-radius:8px; border:0; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; }
    button.secondary { background:#475569; }
    .small { font-size:13px; color:#555; margin-top:8px; }
    footer { margin-top:16px; font-size:13px; color:#666; }
    @media (max-width:700px){ .container{ grid-template-columns:1fr; } video{ height:240px; } }
  </style>
</head>
<body>
  <h1>簡易ビデオ通話（同じ番号でつながる）</h1>
  <div class="container">
    <div class="panel">
      <div>
        <label for="roomInput">ルーム番号（同じ番号を相手と入力してください）</label>
        <input id="roomInput" type="text" placeholder="例: 1234" />
        <div class="controls">
          <button id="startBtn">Start / Join</button>
          <button id="hangupBtn" class="secondary">Hang Up</button>
        </div>
        <div class="small">
          操作手順：両者が同じルーム番号を入力して「Start / Join」を押す。片方が先に押すとルームを作成し、もう片方が押すと参加します。
        </div>
      </div>
    </div>

    <div class="panel">
      <div>
        <label>自分の映像（ローカル）</label>
        <video id="localVideo" playsinline autoplay muted></video>
      </div>
      <div style="margin-top:10px;">
        <label>相手の映像（リモート）</label>
        <video id="remoteVideo" playsinline autoplay></video>
      </div>
    </div>
  </div>

  <footer>
    <div>注意：このサンプルはデモ用。公開する場合は Firebase のルールや API キーの管理、HTTPS 運用を必ず確認してください。</div>
  </footer>

  <!-- Firebase CDN（非モジュール形式） -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase設定 ---
    const firebaseConfig = {
      apiKey: "AIzaSyC9ygh6HjX5mK1e5ZBnEWnLQCEjRMKIEWA",
      authDomain: "sinzo-3f972.firebaseapp.com",
      projectId: "sinzo-3f972",
      storageBucket: "sinzo-3f972.firebasestorage.app",
      messagingSenderId: "1058985227031",
      appId: "1:1058985227031:web:2e3a31346805442e10bd52"
    };

    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const roomInput = document.getElementById('roomInput');
    const startBtn = document.getElementById('startBtn');
    const hangupBtn = document.getElementById('hangupBtn');

    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let roomRef = null;
    let isCaller = false;

    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    async function startLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (e) {
        alert('カメラまたはマイクの許可が必要です。');
        throw e;
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(configuration);
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
      };

      pc.onicecandidate = async event => {
        if (event.candidate) {
          const candidate = event.candidate.toJSON();
          const candidatesCollection = isCaller
            ? roomRef.collection('callerCandidates')
            : roomRef.collection('calleeCandidates');
          await candidatesCollection.add(candidate);
        }
      };
    }

    startBtn.onclick = async () => {
      const roomId = roomInput.value.trim();
      if (!roomId) {
        alert('ルーム番号を入力してください');
        return;
      }

      startBtn.disabled = true;
      await startLocalStream();
      createPeerConnection();

      roomRef = firestore.collection('rooms').doc(roomId);
      const roomSnapshot = await roomRef.get();

      if (!roomSnapshot.exists) {
        isCaller = true;
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

        roomRef.onSnapshot(async snapshot => {
          const data = snapshot.data();
          if (!pc.currentRemoteDescription && data?.answer) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          }
        });

        roomRef.collection('calleeCandidates').onSnapshot(snapshot => {
          snapshot.docChanges().forEach(async change => {
            if (change.type === 'added') {
              const data = change.doc.data();
              await pc.addIceCandidate(new RTCIceCandidate(data));
            }
          });
        });

      } else {
        isCaller = false;
        const data = roomSnapshot.data();
        if (!data.offer) {
          alert('このルームにはオファーがありません。');
          startBtn.disabled = false;
          return;
        }
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

        roomRef.collection('callerCandidates').onSnapshot(snapshot => {
          snapshot.docChanges().forEach(async change => {
            if (change.type === 'added') {
              const data = change.doc.data();
              await pc.addIceCandidate(new RTCIceCandidate(data));
            }
          });
        });
      }
    };

    hangupBtn.onclick = async () => {
      if (pc) pc.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      startBtn.disabled = false;
    };
  </script>
</body>
</html>
